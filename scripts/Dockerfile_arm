FROM tnh-base-arm

########## START ROOT ##########

ENV HOME=/home/webserver
ENV TNH_HOME=$HOME/tnh-http-server
ENV TNH_SETTINGS_JSON=$TNH_HOME/settings.json
ENV TNH_LOG=/var/opt/tnh-server
ENV TNH_EXEC=/usr/local/bin/tnh-server

RUN useradd -ms /bin/bash webserver

RUN mkdir -p $TNH_LOG 
RUN chown webserver:webserver $TNH_LOG

WORKDIR /home/webserver

RUN git clone -b test https://github.com/calvindo95/tnh-http-server.git && \
    cd tnh-http-server/include && wget https://github.com/nlohmann/json/releases/download/v3.11.2/json.hpp && cd .. && \
    mkdir build && cd build && \
    cmake .. && \
    cmake --build . -j4 --target install

COPY --chown=webserver:webserver settings.json $TNH_SETTINGS_JSON

########## END ROOT ##########



########## START WEBSERVER ##########

USER webserver
WORKDIR /home/webserver/tnh-http-server
CMD ["/home/webserver/tnh-http-server/scripts/run_server.sh"]

########## END WEBSERVER ##########